const fs = require("fs").promises;
const path = require("path");
const chalk = require("chalk");
const { ensureMyGit, readIndex, writeIndex } = require("../utils/files");
const { sha1, writeObject } = require("../utils/hash");

async function getAllFiles(dir, fileList = [], baseDir = dir) {
  const files = await fs.readdir(dir);

  for (const file of files) {
    const filePath = path.join(dir, file);
    const stat = await fs.stat(filePath);

    // Skip .mygit directory, node_modules, and .git
    if (file === ".mygit" || file === "node_modules" || file === ".git") {
      continue;
    }

    if (stat.isDirectory()) {
      await getAllFiles(filePath, fileList, baseDir);
    } else {
      // Get relative path from base directory
      const relativePath = path.relative(baseDir, filePath);
      fileList.push(relativePath);
    }
  }

  return fileList;
}

async function add(files) {
  try {
    const repoPath = await ensureMyGit();
    const objectsPath = path.join(repoPath, "objects");

    // Ensure objects folder exists
    try {
      await fs.access(objectsPath);
    } catch {
      await fs.mkdir(objectsPath);
    }

    let index = await readIndex(repoPath);

    // Expand files if '.' is provided
    let filesToAdd = files;
    if (files.includes(".")) {
      filesToAdd = await getAllFiles(process.cwd());
      if (filesToAdd.length === 0) {
        console.log(chalk.yellow("No files to add."));
        return;
      }
    }

    for (const file of filesToAdd) {
      const filePath = path.join(process.cwd(), file);

      try {
        const content = await fs.readFile(filePath);
        const hash = sha1(content);

        // store in .mygit/objects
        await writeObject(repoPath, hash, content);

        // update index
        const stat = await fs.stat(filePath);
        index[file] = {
          hash: hash,
          size: stat.size,
          mtime: stat.mtimeMs,
        };

        console.log(chalk.green(`Added ${file} to staging area.`));
      } catch (error) {
        console.error(chalk.red(`Error adding file ${file}:`, error.message));
      }
    }

    await writeIndex(repoPath, index);
  } catch (error) {
    console.error(chalk.red("Error in add command:", error.message));
  }
}

module.exports = { add };
